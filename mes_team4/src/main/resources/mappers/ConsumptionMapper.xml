<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 파일이름 대신 namespace 이름을 불러서 사용 -->

<mapper namespace="com.itwillbs.mappers.ConsumptionMapper">
	
	<!-- ?대신 #{변수값}-->
	
	<resultMap type="map" id="prListMap">
		<!-- column="DB의 열이름" property="해당 DB열에 대해 저장할 변수이름"-->
		<result column="product_cd_name" property="prCdName"/>
		<result column="product_name" property="prName"/>
		<result column="product_type_name" property="prTypeName"/>
		<result column="product_type_cd" property="prTypeCd"/>
	</resultMap>
	
	<select id="getCpList" resultMap="prListMap">
		select p.product_cd_name, p.product_name, pt.product_type_name, pt.product_type_cd
		from product p join product_type pt
		on p.product_type_cd = pt.product_type_cd 
		where product_dv = '완제품'
		order by pt.product_type_cd, p.product_cd_name
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getCpCount" resultType="java.lang.Integer">
		select count(*)
		from product p join product_type pt
		on p.product_type_cd = pt.product_type_cd
		where product_dv = '완제품'
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
	</select>
	
	<select id="getRpList" resultMap="prListMap">
		select p.product_cd_name, p.product_name, pt.product_type_name, pt.product_type_cd
		from product p join product_type pt
		on p.product_type_cd = pt.product_type_cd 
		where product_dv = '원자재'
		order by pt.product_type_cd, p.product_cd_name
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getRpCount" resultType="java.lang.Integer">
		select count(*)
		from product p join product_type pt
		on p.product_type_cd = pt.product_type_cd
		where product_dv = '원자재'
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
	</select>
	
	<insert id="insertConsmpt" parameterType="map">
	  insert into consumption_management (cproduct_cd_name, cproduct_name, rproduct_cd_name, rproduct_name, consumption, consumption_unit, insert_date)
	  values
	  <foreach item="consmpt" index="index" collection="consmptArray" separator=",">
		  (#{consmpt.cproduct_cd_name},
		   #{consmpt.cproduct_name},
		   #{consmpt.rproduct_cd_name},
		   #{consmpt.rproduct_name},
		   #{consmpt.consumption},
		   #{consmpt.consumption_unit},
		   now())
	  </foreach>
	</insert>
	
	<select id="checkCprCdName" resultType="com.itwillbs.domain.ConsumptionDTO">
		select *
		from consumption_management
		where cproduct_cd_name = #{cprCdName}
	</select>
	
	<select id="getConsmptList" resultType="com.itwillbs.domain.ConsumptionDTO">
		select *  
		from consumption_management
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getCprConsmptList" resultType="com.itwillbs.domain.ConsumptionDTO">
		select *  
		from consumption_management
		group by cproduct_cd_name
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
	</select>
	
	<select id="getCprConsmptCount" resultType="java.lang.Integer">
		select count(*)  
		from (
    	select *
   		from consumption_management
    	group by cproduct_cd_name
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
		) as sub
	</select>
	
	<select id="getRprConsmptList" parameterType="map" resultType="com.itwillbs.domain.ConsumptionDTO">
		select *  
		from consumption_management
		where cproduct_cd_name in 
        <foreach item="name" collection="cprCdNameList" index="index" open="(" separator="," close=")">
        	#{name}
        </foreach>
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
	</select>
	
	<resultMap id="ListIntegerMap" type="java.lang.Integer" />
	
	<select id="getRowcolsTd" resultMap="ListIntegerMap">
		SELECT count(*)
		from consumption_management
		group by cproduct_cd_name
		<!-- <if test="search != null">
			where subject like CONCAT('%',#{search},'%')
		</if> -->
		limit #{startRow},#{pageSize}
	</select>
	
</mapper>



